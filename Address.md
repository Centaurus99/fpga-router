Thinpad 工程
---------------

### Wishbone 总线地址设定

#### 时钟中断

|    地址    |                     说明                     |
| :--------: | :------------------------------------------: |
| 0x0200BFF8 |      mtime，64位，可读写。表示当前时间       |
| 0x02004000 | mtimecmp，64位，可读写。表示下次时钟中断时间 |

#### UART 串口

|    地址    |  位   |                        说明                        |
| :--------: | :---: | :------------------------------------------------: |
| 0x10000000 | [7:0] | 串口数据，读、写地址分别表示串口接收、发送一个字节 |
| 0x10000005 |  [5]  |        只读，为1时表示串口空闲，可发送数据         |
| 0x10000005 |  [0]  |            只读，为1时表示串口收到数据             |

#### GPIO

|       地址区间        |                       说明                       |
| :-------------------: | :----------------------------------------------: |
| 0x20000000-0x20000003 | 4位touch_btn和16位拨码开关组成的模拟键盘（只读） |
| 0x20000004-0x20000005 |                 16位leds（读写）                 |
|      0x20000008       |        8位dpy0和dpy1，输出带译码（读写）         |

#### BRAM——VGA图片存储（已禁用）

|       地址区间        | 说明  | 存储单元数据位宽 | 对齐后数据位宽 | 存储单元地址数量 | 存储单元地址位宽 | BRAM 数量 |
| :-------------------: | :---: | :--------------: | :------------: | :--------------: | :--------------: | :-------: |
| 0x30000000-0x30FFFFFF | BRAM1 |        32        |       32       |      480000      |        19        |   107.5   |

#### BRAM——转发表内部节点

|       地址区间        | 说明  | 存储单元数据位宽 | 对齐后数据位宽 | 存储单元地址数量 | 存储单元地址位宽 | BRAM 数量 | IP 地址前缀 |
| :-------------------: | :---: | :--------------: | :------------: | :--------------: | :--------------: | :-------: | :---------: |
| 0x40000000-0x40FFFFFF | BRAM1 |        72        |      128       |       1024       |        10        |     2     |    0-15     |
| 0x41000000-0x41FFFFFF | BRAM2 |        72        |      128       |      32768       |        15        |    64     |    16-31    |
| 0x42000000-0x42FFFFFF | BRAM3 |        72        |      128       |      65536       |        16        |    128    |    32-47    |
| 0x43000000-0x43FFFFFF | BRAM0 |        72        |      128       |       1024       |        10        |     2     |    48-63    |
| 0x44000000-0x44FFFFFF | BRAM0 |        72        |      128       |       1024       |        10        |     2     |    64-79    |
| 0x45000000-0x45FFFFFF | BRAM0 |        72        |      128       |       1024       |        10        |     2     |    80-95    |
| 0x46000000-0x46FFFFFF | BRAM0 |        72        |      128       |       1024       |        10        |     2     |   96-111    |
| 0x47000000-0x47FFFFFF | BRAM0 |        72        |      128       |       1024       |        10        |     2     |   112-127   |

#### LUTRAM——叶节点和 Next-Hop 节点

|       地址区间        |              说明              | 存储单元数据位宽 | 对齐后数据位宽 | 存储单元地址数量 | 存储单元地址位宽 | LUT 数量 |
| :-------------------: | :----------------------------: | :--------------: | :------------: | :--------------: | :--------------: | :------: |
| 0x50000000-0x50FFFFFF | 叶节点（已禁用，改至 Ext RAM） |        8         |       32       |       1024       |        10        |   未知   |
| 0x51000000-0x51FFFFFF |         Next-Hop 结点          |       136        |      256       |       128        |        7         |   未知   |

#### 路由器 MMIO&DMA

##### 路由端口统计数据

- `0x6000_0p00` 为 p 端口 32 位发包字节计数
- `0x6000_0p04` 为 p 端口 32 位收包字节计数

|       地址区间        |       说明        |
| :-------------------: | :---------------: |
| 0x60000000-0x600000FF | 路由器端口 0 统计 |
| 0x60000100-0x600001FF | 路由器端口 1 统计 |
| 0x60000200-0x600002FF | 路由器端口 2 统计 |
| 0x60000300-0x600003FF | 路由器端口 3 统计 |

##### 路由器端口配置

- `0x6100_0p00` 为 p 端口 48 位 mac 地址（对齐至 64 位，低 48 位有效）
- `0x6100_0p08` 为 eui64 只写控制寄存器（对齐至 64 位），向该地址写入任何非零值会导致该端口链路本地地址会被 eui64 生成的地址覆盖
- `0x6100_0p10` 为 p 端口 128 位 ipv6 链路本地地址
- `0x6100_0p20` 为 p 端口 128 位 ipv6 GUA 地址

|       地址区间        |       说明        |
| :-------------------: | :---------------: |
| 0x61000000-0x610000FF | 路由器端口 0 配置 |
| 0x61000100-0x610001FF | 路由器端口 1 配置 |
| 0x61000200-0x610002FF | 路由器端口 2 配置 |
| 0x61000300-0x610003FF | 路由器端口 3 配置 |

##### DMA 控制 MMIO

|    地址    |  位  |                             说明                             |
| :--------: | :--: | :----------------------------------------------------------: |
| 0x62000000 | [0]  | （可读写）DMA CPU 锁<br />写入 1 为请求使用，请求不一定成功，写入后须读取验证 |
| 0x62000000 | [1]  |                    （可读）DMA Router 锁                     |
| 0x62000000 | [2]  |    （可读写）等待 CPU 读取<br />写入 1 表示 CPU 读取完成     |
| 0x62000000 | [3]  |   （可读写）等待 Router 读取<br />写入 1 表示 CPU 写入完成   |
| 0x62000000 | [4]  |                   （可写）结束请求，释放锁                   |
| 0x62000000 | [6]  |                  （可写）请求计算部分校验和                  |
| 0x62000000 | [7]  |      （可读）校验和计算完成，存放在 DMA 数据的后 16 位       |

##### 路由器板内统计数据

|    地址    |   位   |       说明        |
| :--------: | :----: | :---------------: |
| 0x63000000 | [31:0] | 当前 DMA 队列长度 |

##### DMA 共享内存 BRAM

|       地址区间        |      说明      | 存储单元数据位宽 | 存储单元地址数量 | 存储单元地址位宽 | BRAM 数量 |
| :-------------------: | :------------: | :--------------: | :--------------: | :--------------: | :-------: |
| 0x68000000-0x680003FF | 前四字节为长度 |        32        |       1024       |        10        |     1     |

注：

- 前四字节为长度
- 读取到的第一个字节为接口号（覆盖目的 MAC 地址）
- 若读取时 `ETHERTYPE` 非 IPv6 (`0x86dd`) ，则视为请求回发 ICMP 信息，`ETHERTYPE` 为 Type 和 Code。
- 写入后，会自动将 `ETHERTYPE` 填为 IPv6 (`0x86dd`) 。
- 若写入时将 MAC 源地址设为路由器对应接口的 MAC 地址，则会不经过转发逻辑，直接从对应接口发出。
- 若写入时将 IPv6 目的地址设为组播地址，则会不经过转发逻辑，直接从对应接口发出。若未如上设置接口，则会发回 CPU。
- 若写入时将 IPv6 目的地址设为 loopback 地址（`::1`），则会发回 CPU。

#### SRAM

|       地址区间        |          说明           |
| :-------------------: | :---------------------: |
| 0x80000000-0x803FFFFF |        Base RAM         |
| 0x80400000-0x807FFFFF | Ext RAM, 用于存放叶节点 |

#### Flash（预留，已禁用）

|       地址区间        |              说明               |
| :-------------------: | :-----------------------------: |
| 0x90000000-0x907FFFFF | BaseRAM与ExtRAM的初始数据的存储 |

